api:
  definitions:
  - name: QuotaDetailsPath
    data: !Struct
      doc: null
      properties:
        quota: String
  - name: Quota
    data: !Struct
      doc: Quota specification
      properties:
        replanish_interval: f64
        burst_capacity: i64
  - name: MatchRule
    data: !Struct
      doc: null
      properties: {}
  - name: QuotaState
    data: !Struct
      doc: State information of the quota
      properties:
        earliest_next_available: f64
        remaining_burst_capacity: i64
  - name: QuotaStats
    data: !Struct
      doc: Quota statistics, purely descriptive. Not used in Rate limiting decisions.
      properties:
        rpm: i64
  - name: QuotaDetails
    data: !Struct
      doc: Full information about quota
      properties:
        quota: Quota
        match: Vec<MatchRule>
        state: QuotaState
        stats: QuotaStats
  - name: QuotaDetailsResponseError
    data: !ApiErr
      variants:
      - name: QuotaNotFound
        detail: Quota not found
        code: NOT_FOUND
  - name: MatchRule
    data: !Struct
      doc: null
      properties: {}
  - name: CellTestQuery
    data: !Struct
      doc: null
      properties:
        query: MatchRule
  - name: Quota
    data: !Struct
      doc: Quota specification
      properties:
        replanish_interval: f64
        burst_capacity: i64
  - name: QuotaState
    data: !Struct
      doc: State information of the quota
      properties:
        earliest_next_available: f64
        remaining_burst_capacity: i64
  - name: CellDetails
    data: !Struct
      doc: |
        Information about current cell state and matched quotas.
        Matched quotas are computed based on query.
        Info and state are computed dynamically based on matched quotas.
      properties:
        quotas: Vec<String>
        info: Quota
        state: QuotaState
  - name: CellTestResponseError
    data: !ApiErr
      variants:
      - name: DuplicateQueryKey
        detail: Duplicate query key
        code: BAD_REQUEST
      - name: NoQuotasMatchingQueryFound
        detail: No quotas matching query found
        code: NOT_FOUND
  - name: MatchRule
    data: !Struct
      doc: null
      properties: {}
  - name: CellUpdateQuery
    data: !Struct
      doc: null
      properties:
        query: MatchRule
  - name: Quota
    data: !Struct
      doc: Quota specification
      properties:
        replanish_interval: f64
        burst_capacity: i64
  - name: QuotaState
    data: !Struct
      doc: State information of the quota
      properties:
        earliest_next_available: f64
        remaining_burst_capacity: i64
  - name: CellInfo
    data: !Struct
      doc: |
        Information about current cell state.
        Info and state are computed dynamically based on matched quotas.
      properties:
        info: Quota
        state: QuotaState
  - name: UpdateResult
    data: !Struct
      doc: |
        Result of the cell update. Allowed/Denied flag + cell info
      properties:
        allowed: bool
        details: CellInfo
  - name: CellUpdateResponseError
    data: !ApiErr
      variants:
      - name: DuplicateQueryKey
        detail: Duplicate query key
        code: BAD_REQUEST
      - name: NoQuotasMatchingQueryFound
        detail: No quotas matching query found
        code: NOT_FOUND
  operations:
  - name: health
    path: /health
    method: Get
    doc: Check service health
    param_path: null
    param_query: null
    param_body: null
    response: web::Json<String>
  - name: quota_list
    path: /quota
    method: Get
    doc: List quotas
    param_path: null
    param_query: null
    param_body: null
    response: web::Json<Vec<String>>
  - name: quota_details
    path: /quota/{quota}
    method: Get
    doc: Get quota details
    param_path: web::Path<QuotaDetailsPath>
    param_query: null
    param_body: null
    response: Result<web::Json<QuotaDetails>,QuotaDetailsResponseError>
  - name: cell_test
    path: /cell/test
    method: Get
    doc: Get current rate limitation state for given query
    param_path: null
    param_query: web::Query<CellTestQuery>
    param_body: null
    response: Result<web::Json<CellDetails>,CellTestResponseError>
  - name: cell_update
    path: /cell/update
    method: Post
    doc: Try to accomodate for one request
    param_path: null
    param_query: web::Query<CellUpdateQuery>
    param_body: null
    response: Result<web::Json<UpdateResult>,CellUpdateResponseError>
