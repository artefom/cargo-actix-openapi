api:
  definitions:
  - name: QuotaDetailsPath
    data: !Struct
      doc: null
      properties:
      - name: quota
        rename: quota
        default: null
        type_: String
  - name: Quota
    data: !Struct
      doc: Quota specification
      properties:
      - name: replanish_interval
        rename: replanish_interval
        default: null
        type_: f64
      - name: burst_capacity
        rename: burst_capacity
        default: null
        type_: i64
  - name: MatchRule
    data: !Struct
      doc: null
      properties: []
  - name: QuotaState
    data: !Struct
      doc: State information of the quota
      properties:
      - name: earliest_next_available
        rename: earliest_next_available
        default: null
        type_: f64
      - name: remaining_burst_capacity
        rename: remaining_burst_capacity
        default: null
        type_: i64
  - name: QuotaStats
    data: !Struct
      doc: Quota statistics, purely descriptive. Not used in Rate limiting decisions.
      properties:
      - name: rpm
        rename: rpm
        default: null
        type_: i64
  - name: QuotaDetails
    data: !Struct
      doc: Full information about quota
      properties:
      - name: quota
        rename: quota
        default: null
        type_: Quota
      - name: match_
        rename: match
        default: null
        type_: Vec<MatchRule>
      - name: state
        rename: state
        default: null
        type_: QuotaState
      - name: stats
        rename: stats
        default: null
        type_: QuotaStats
  - name: QuotaDetailsResponseError
    data: !ApiErr
      variants:
      - name: QuotaNotFound
        detail: Quota not found
        code: NOT_FOUND
  - name: MatchRule
    data: !Struct
      doc: null
      properties: []
  - name: CellTestQuery
    data: !Struct
      doc: null
      properties:
      - name: query
        rename: query
        default: null
        type_: MatchRule
  - name: Quota
    data: !Struct
      doc: Quota specification
      properties:
      - name: replanish_interval
        rename: replanish_interval
        default: null
        type_: f64
      - name: burst_capacity
        rename: burst_capacity
        default: null
        type_: i64
  - name: QuotaState
    data: !Struct
      doc: State information of the quota
      properties:
      - name: earliest_next_available
        rename: earliest_next_available
        default: null
        type_: f64
      - name: remaining_burst_capacity
        rename: remaining_burst_capacity
        default: null
        type_: i64
  - name: CellDetails
    data: !Struct
      doc: |
        Information about current cell state and matched quotas.
        Matched quotas are computed based on query.
        Info and state are computed dynamically based on matched quotas.
      properties:
      - name: quotas
        rename: quotas
        default: null
        type_: Vec<String>
      - name: info
        rename: info
        default: null
        type_: Quota
      - name: state
        rename: state
        default: null
        type_: QuotaState
  - name: CellTestResponseError
    data: !ApiErr
      variants:
      - name: DuplicateQueryKey
        detail: Duplicate query key
        code: BAD_REQUEST
      - name: NoQuotasMatchingQueryFound
        detail: No quotas matching query found
        code: NOT_FOUND
  - name: MatchRule
    data: !Struct
      doc: null
      properties: []
  - name: CellUpdateQuery
    data: !Struct
      doc: null
      properties:
      - name: query
        rename: query
        default: null
        type_: MatchRule
  - name: Quota
    data: !Struct
      doc: Quota specification
      properties:
      - name: replanish_interval
        rename: replanish_interval
        default: null
        type_: f64
      - name: burst_capacity
        rename: burst_capacity
        default: null
        type_: i64
  - name: QuotaState
    data: !Struct
      doc: State information of the quota
      properties:
      - name: earliest_next_available
        rename: earliest_next_available
        default: null
        type_: f64
      - name: remaining_burst_capacity
        rename: remaining_burst_capacity
        default: null
        type_: i64
  - name: CellInfo
    data: !Struct
      doc: |
        Information about current cell state.
        Info and state are computed dynamically based on matched quotas.
      properties:
      - name: info
        rename: info
        default: null
        type_: Quota
      - name: state
        rename: state
        default: null
        type_: QuotaState
  - name: UpdateResult
    data: !Struct
      doc: |
        Result of the cell update. Allowed/Denied flag + cell info
      properties:
      - name: allowed
        rename: allowed
        default: null
        type_: bool
      - name: details
        rename: details
        default: null
        type_: CellInfo
  - name: CellUpdateResponseError
    data: !ApiErr
      variants:
      - name: DuplicateQueryKey
        detail: Duplicate query key
        code: BAD_REQUEST
      - name: NoQuotasMatchingQueryFound
        detail: No quotas matching query found
        code: NOT_FOUND
  operations:
  - name: health
    path: /health
    method: Get
    doc: Check service health
    param_path: null
    param_query: null
    param_body: null
    response: web::Json<String>
  - name: quota_list
    path: /quota
    method: Get
    doc: List quotas
    param_path: null
    param_query: null
    param_body: null
    response: web::Json<Vec<String>>
  - name: quota_details
    path: /quota/{quota}
    method: Get
    doc: Get quota details
    param_path: web::Path<QuotaDetailsPath>
    param_query: null
    param_body: null
    response: Result<web::Json<QuotaDetails>,QuotaDetailsResponseError>
  - name: cell_test
    path: /cell/test
    method: Get
    doc: Get current rate limitation state for given query
    param_path: null
    param_query: web::Query<CellTestQuery>
    param_body: null
    response: Result<web::Json<CellDetails>,CellTestResponseError>
  - name: cell_update
    path: /cell/update
    method: Post
    doc: Try to accomodate for one request
    param_path: null
    param_query: web::Query<CellUpdateQuery>
    param_body: null
    response: Result<web::Json<UpdateResult>,CellUpdateResponseError>
